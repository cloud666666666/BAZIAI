<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BaziAI - 智能八字分析系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .btn {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }
        
        .btn:hover {
            background-color: #45a049;
        }
        
        .result-container {
            margin-top: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            display: none;
        }
        
        .result-section {
            margin-bottom: 20px;
        }
        
        .result-section h3 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
        }
        
        .bazi-display {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
            padding: 15px;
            background-color: #ecf0f1;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .hexagram-info {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }
        
        .hexagram-card {
            flex: 1;
            padding: 15px;
            background-color: white;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .hexagram-card h4 {
            margin-top: 0;
            color: #4CAF50;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        .error {
            color: #e74c3c;
            background-color: #fdf2f2;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        
        .llm-analysis {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
            font-family: 'Microsoft YaHei', sans-serif;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            min-height: 100px;
        }
        
        .llm-analysis h1, .llm-analysis h2, .llm-analysis h3 {
            color: #2c3e50;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        .llm-analysis h1 {
            font-size: 1.5em;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
        }
        
        .llm-analysis h2 {
            font-size: 1.3em;
            color: #34495e;
        }
        
        .llm-analysis h3 {
            font-size: 1.1em;
            color: #7f8c8d;
        }
        
        .llm-analysis strong {
            color: #2c3e50;
            font-weight: bold;
        }
        
        .llm-analysis ul, .llm-analysis ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .llm-analysis li {
            margin: 5px 0;
        }
        
        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 1em;
            background-color: #4CAF50;
            animation: blink 1s infinite;
            margin-left: 2px;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .streaming-indicator {
            display: none;
            color: #4CAF50;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .streaming-indicator.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>BaziAI - 智能八字分析系统</h1>
        <p>请输入您的出生时间，系统将为您生成八字并分析对应的易经卦象。</p>
        
        <form id="baziForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="year">出生年份：</label>
                    <input type="number" id="year" name="year" min="1900" max="2100" required>
                </div>
                <div class="form-group">
                    <label for="month">出生月份：</label>
                    <input type="number" id="month" name="month" min="1" max="12" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="day">出生日期：</label>
                    <input type="number" id="day" name="day" min="1" max="31" required>
                </div>
                <div class="form-group">
                    <label for="hour">出生时辰：</label>
                    <select id="hour" name="hour" required>
                        <option value="">请选择时辰</option>
                        <option value="0">子时 (23:00-01:00)</option>
                        <option value="1">丑时 (01:00-03:00)</option>
                        <option value="2">寅时 (03:00-05:00)</option>
                        <option value="3">卯时 (05:00-07:00)</option>
                        <option value="4">辰时 (07:00-09:00)</option>
                        <option value="5">巳时 (09:00-11:00)</option>
                        <option value="6">午时 (11:00-13:00)</option>
                        <option value="7">未时 (13:00-15:00)</option>
                        <option value="8">申时 (15:00-17:00)</option>
                        <option value="9">酉时 (17:00-19:00)</option>
                        <option value="10">戌时 (19:00-21:00)</option>
                        <option value="11">亥时 (21:00-23:00)</option>
                    </select>
                </div>
            </div>
            
            <button type="submit" class="btn">生成八字分析</button>
        </form>
        
        <div class="loading" id="loading">
            <p>正在分析中，请稍候...</p>
        </div>
        
        <div class="error" id="error"></div>
        
        <div class="result-container" id="resultContainer">
            <div class="result-section">
                <h3>八字信息</h3>
                <div class="bazi-display" id="baziDisplay"></div>
                <p><strong>生肖：</strong><span id="shengxiao"></span></p>
                <p id="shengxiaoInfo" style="color: #666; font-size: 14px;"></p>
            </div>
            
            <div class="result-section">
                <h3>卦象分析</h3>
                <div class="hexagram-info">
                    <div class="hexagram-card">
                        <h4>主卦</h4>
                        <p><strong>卦名：</strong><span id="mainHexagramName"></span></p>
                        <p><strong>卦辞：</strong><span id="mainHexagramText"></span></p>
                    </div>
                    <div class="hexagram-card">
                        <h4>变卦</h4>
                        <p><strong>卦名：</strong><span id="changingHexagramName"></span></p>
                        <p><strong>卦辞：</strong><span id="changingHexagramText"></span></p>
                    </div>
                </div>
            </div>
            
            <div class="result-section">
                <h3>五行信息</h3>
                <p><strong>天干五行：</strong><span id="ganWuxing"></span></p>
                <p><strong>地支五行：</strong><span id="zhiWuxing"></span></p>
            </div>
            
            <div class="result-section">
                <h3>基础卦象分析</h3>
                <p id="basicAnalysis"></p>
            </div>
            
            <div class="result-section">
                <h3>AI智能分析</h3>
                <div id="llmAnalysis" class="llm-analysis"></div>
                <div id="streamingIndicator" class="streaming-indicator">
                    <span>AI正在分析中...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isStreaming = false;
        let currentAnalysis = '';
        
        document.getElementById('baziForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (isStreaming) {
                return; // 防止重复提交
            }
            
            const formData = new FormData(this);
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const resultContainer = document.getElementById('resultContainer');
            const streamingIndicator = document.getElementById('streamingIndicator');
            const llmAnalysis = document.getElementById('llmAnalysis');
            
            // 重置状态
            isStreaming = true;
            currentAnalysis = '';
            loading.style.display = 'block';
            error.style.display = 'none';
            resultContainer.style.display = 'none';
            streamingIndicator.classList.remove('active');
            llmAnalysis.innerHTML = '';
            
            // 使用流式传输
            fetch('/bazi_analysis_stream', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络请求失败');
                }
                return response.body.getReader();
            })
            .then(reader => {
                loading.style.display = 'none';
                resultContainer.style.display = 'block';
                streamingIndicator.classList.add('active');
                
                function readStream() {
                    return reader.read().then(({ done, value }) => {
                        if (done) {
                            isStreaming = false;
                            streamingIndicator.classList.remove('active');
                            return;
                        }
                        
                        // 解码数据
                        const chunk = new TextDecoder().decode(value);
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    handleStreamData(data);
                                } catch (e) {
                                    console.error('解析数据失败:', e);
                                }
                            }
                        }
                        
                        return readStream();
                    });
                }
                
                return readStream();
            })
            .catch(err => {
                isStreaming = false;
                loading.style.display = 'none';
                error.textContent = '请求失败，请重试: ' + err.message;
                error.style.display = 'block';
                streamingIndicator.classList.remove('active');
                console.error('Error:', err);
            });
        });
        
        function handleStreamData(data) {
            switch (data.type) {
                case 'base_data':
                    displayBaseResults(data.data);
                    break;
                case 'llm_chunk':
                    appendToAnalysis(data.content);
                    break;
                case 'llm_complete':
                    setAnalysis(data.content);
                    break;
                case 'llm_error':
                    setAnalysisError(data.content);
                    break;
                case 'complete':
                    isStreaming = false;
                    document.getElementById('streamingIndicator').classList.remove('active');
                    break;
            }
        }
        
        function displayBaseResults(data) {
            document.getElementById('baziDisplay').textContent = data.八字;
            document.getElementById('shengxiao').textContent = data.生肖;
            document.getElementById('mainHexagramName').textContent = data.主卦.名称 || '未知';
            document.getElementById('mainHexagramText').textContent = data.主卦.卦辞 || '暂无卦辞';
            document.getElementById('changingHexagramName').textContent = data.变卦.名称 || '未知';
            document.getElementById('changingHexagramText').textContent = data.变卦.卦辞 || '暂无卦辞';
            document.getElementById('ganWuxing').textContent = data.五行信息.天干五行;
            document.getElementById('zhiWuxing').textContent = data.五行信息.地支五行;
            document.getElementById('basicAnalysis').textContent = data.基础分析;
            
            // 显示生肖信息
            let shengxiaoInfo = '';
            if (data.春节日期) {
                shengxiaoInfo += `春节日期：${data.春节日期}`;
            }
            if (data.是否春节前) {
                shengxiaoInfo += ` | 是否春节前：${data.是否春节前}`;
            }
            if (data.立春日期) {
                shengxiaoInfo += ` | 立春日期：${data.立春日期}`;
            }
            if (data.农历说明) {
                shengxiaoInfo += ` | ${data.农历说明}`;
            }
            
            document.getElementById('shengxiaoInfo').textContent = shengxiaoInfo;
        }
        
        function appendToAnalysis(content) {
            currentAnalysis += content;
            updateAnalysisDisplay();
        }
        
        function setAnalysis(content) {
            currentAnalysis = content;
            updateAnalysisDisplay();
        }
        
        function setAnalysisError(errorMsg) {
            currentAnalysis = errorMsg;
            updateAnalysisDisplay();
        }
        
        function updateAnalysisDisplay() {
            const llmAnalysis = document.getElementById('llmAnalysis');
            const streamingIndicator = document.getElementById('streamingIndicator');
            
            // 清理和格式化内容
            let formattedContent = currentAnalysis
                .replace(/\\n/g, '\n')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/### (.*?)(?=\n|$)/g, '<h3>$1</h3>')
                .replace(/## (.*?)(?=\n|$)/g, '<h2>$1</h2>')
                .replace(/# (.*?)(?=\n|$)/g, '<h1>$1</h1>')
                .replace(/^\d+\.\s+(.*?)$/gm, '<li>$1</li>')
                .replace(/^-\s+(.*?)$/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            // 确保内容被包裹在段落中
            if (!formattedContent.startsWith('<')) {
                formattedContent = '<p>' + formattedContent + '</p>';
            }
            
            // 添加打字机光标效果
            if (isStreaming) {
                formattedContent += '<span class="typing-cursor"></span>';
            }
            
            llmAnalysis.innerHTML = formattedContent;
            
            // 滚动到底部
            llmAnalysis.scrollTop = llmAnalysis.scrollHeight;
        }
    </script>
</body>
</html>
